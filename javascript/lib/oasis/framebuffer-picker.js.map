{"version":3,"file":"module.js","sources":["../src/ColorMaterial.ts","../src/ColorRenderPass.ts","../src/FramebufferPicker.ts"],"sourcesContent":["import { Engine, Logger, Material, RenderElement, Shader, Vector3 } from \"oasis-engine\";\nimport fs from \"./color.fs.glsl\";\nimport vs from \"./color.vs.glsl\";\n\nShader.create(\"framebuffer-picker-color\", vs, fs);\n\n/**\n * Color material, render as marker.\n */\nexport class ColorMaterial extends Material {\n  private _currentId: number = 0;\n  private _primitivesMap = [];\n\n  constructor(engine: Engine) {\n    super(engine, Shader.find(\"framebuffer-picker-color\"));\n  }\n\n  /**\n   * Reset id and renderer element table.\n   */\n  reset(): void {\n    this._currentId = 0;\n    this._primitivesMap = [];\n  }\n\n  /**\n   * Convert id to RGB color value, 0 and 0xffffff are illegal values.\n   */\n  id2Color(id: number): Vector3 {\n    if (id >= 0xffffff) {\n      Logger.warn(\"Framebuffer Picker encounter primitive's id greater than \" + 0xffffff);\n      return new Vector3(0, 0, 0);\n    }\n\n    const color = new Vector3((id & 0xff) / 255, ((id & 0xff00) >> 8) / 255, ((id & 0xff0000) >> 16) / 255);\n    return color;\n  }\n\n  /**\n   * Convert RGB color to id.\n   * @param color - Color\n   */\n  color2Id(color): number {\n    return color[0] | (color[1] << 8) | (color[2] << 16);\n  }\n\n  /**\n   * Get renderer element by color.\n   */\n  getObjectByColor(color) {\n    return this._primitivesMap[this.color2Id(color)];\n  }\n\n  /**\n   * @override\n   */\n  _preRender(renderElement: RenderElement) {\n    const { component, primitive } = renderElement;\n    this._currentId += 1;\n    this._primitivesMap[this._currentId] = { component, primitive };\n    component.shaderData.setVector3(\"u_colorId\", this.id2Color(this._currentId));\n  }\n}\n","import { Camera, Engine, Layer, RenderPass, RenderTarget } from \"oasis-engine\";\nimport { ColorMaterial } from \"./ColorMaterial\";\n\n/**\n * Color render Pass, used to render marker.\n */\nclass ColorRenderPass extends RenderPass {\n  private _needPick: boolean;\n  private onPick: Function;\n  private _pickPos;\n\n  constructor(name: string, priority: number, renderTarget: RenderTarget, mask: Layer, engine?: Engine) {\n    super(name, priority, renderTarget, new ColorMaterial(engine), mask);\n\n    this._needPick = false;\n    this.onPick = (o: any) => console.log(o);\n  }\n\n  /**\n   * Determine whether need to render pass, reset state.\n   * @override\n   */\n  preRender(camera, queue) {\n    if (this._needPick) {\n      this.enabled = true;\n      (this.replaceMaterial as ColorMaterial).reset();\n    } else {\n      this.enabled = false;\n    }\n  }\n\n  /**\n   * Determine whether to pick up.\n   * @override\n   */\n  postRender(camera: Camera, queue) {\n    if (this._needPick) {\n      const color = this.readColorFromRenderTarget(camera);\n      const object = (this.replaceMaterial as ColorMaterial).getObjectByColor(color);\n      this._needPick = false;\n\n      if (this.onPick) this.onPick(object);\n    }\n  }\n\n  /**\n   * Pick up coordinate pixels.\n   */\n  pick(x: number, y: number) {\n    this._pickPos = [x, y];\n    this._needPick = true;\n  }\n\n  /**\n   * Get pixel color value from framebuffer.\n   */\n  readColorFromRenderTarget(camera: Camera) {\n    const gl = camera.engine.renderhardware.gl;\n    const screenPoint = this._pickPos;\n    const canvas = gl.canvas;\n    const clientWidth = canvas.clientWidth;\n    const clientHeight = canvas.clientHeight;\n    const canvasWidth = gl.drawingBufferWidth;\n    const canvasHeight = gl.drawingBufferHeight;\n\n    const px = (screenPoint[0] / clientWidth) * canvasWidth;\n    const py = (screenPoint[1] / clientHeight) * canvasHeight;\n\n    const viewport = camera.viewport;\n    const viewWidth = (viewport.z - viewport.x) * canvasWidth;\n    const viewHeight = (viewport.w - viewport.y) * canvasHeight;\n\n    const nx = (px - viewport.x) / viewWidth;\n    const ny = (py - viewport.y) / viewHeight;\n    const left = Math.floor(nx * (this.renderTarget.width - 1));\n    const bottom = Math.floor((1 - ny) * (this.renderTarget.height - 1));\n    const pixel = new Uint8Array(4);\n\n    this.renderTarget.getColorTexture().getPixelBuffer(null, left, bottom, 1, 1, pixel);\n    return pixel;\n  }\n}\n\nexport { ColorRenderPass };\n","import { Camera, Entity, RenderColorTexture, RenderTarget, Script } from \"oasis-engine\";\nimport { ColorRenderPass } from \"./ColorRenderPass\";\n\n/**\n * Framebuffer picker.\n * @remarks Can pick up renderer at pixel level.\n */\nexport class FramebufferPicker extends Script {\n  public colorRenderTarget: RenderTarget;\n  public colorRenderPass: ColorRenderPass;\n\n  private _camera: Camera;\n  private _needPick: boolean;\n  private _pickPos: [number, number];\n\n  /**\n   * Camera.\n   */\n  get camera(): Camera {\n    return this._camera;\n  }\n\n  set camera(value: Camera) {\n    if (this._camera !== value) {\n      this._camera = value;\n      //@ts-ignore\n      this.camera._renderPipeline.addRenderPass(this.colorRenderPass);\n    }\n  }\n\n  constructor(entity: Entity) {\n    super(entity);\n    const width = 1024;\n    const height = 1024;\n    this.colorRenderTarget = new RenderTarget(\n      this.engine,\n      width,\n      height,\n      new RenderColorTexture(this.engine, width, height)\n    );\n    this.colorRenderPass = new ColorRenderPass(\"ColorRenderTarget_FBP\", -1, this.colorRenderTarget, 0, this.engine);\n  }\n\n  /**\n   * Set the callback function after pick up.\n   * @param {Function} fun Callback function. if there is an renderer selected, the parameter 1 is {component, primitive }, otherwise it is undefined\n   */\n  set onPick(fun: Function) {\n    if (typeof fun === \"function\") {\n      (this.colorRenderPass as any).onPick = fun;\n    }\n  }\n\n  /**\n   * Pick the object at the screen coordinate position.\n   * @param offsetX Relative X coordinate of the canvas\n   * @param offsetY Relative Y coordinate of the canvas\n   */\n  pick(offsetX: number, offsetY: number) {\n    if (this.enabled) {\n      this._needPick = true;\n      this._pickPos = [offsetX, offsetY];\n    }\n  }\n\n  onUpdate(deltaTime: number) {\n    super.onUpdate(deltaTime);\n\n    if (this.enabled && this._needPick) {\n      this.colorRenderPass.pick(this._pickPos[0], this._pickPos[1]);\n      this._needPick = false;\n    }\n  }\n\n  onDestroy() {\n    //@ts-ignore\n    this.camera._renderPipeline.removeRenderPass(this.colorRenderPass);\n  }\n}\n"],"names":["Shader","create","vs","fs","ColorMaterial","engine","find","_currentId","_primitivesMap","reset","id2Color","id","Logger","warn","Vector3","color","color2Id","getObjectByColor","_preRender","renderElement","component","primitive","shaderData","setVector3","Material","ColorRenderPass","name","priority","renderTarget","mask","_needPick","onPick","_pickPos","o","console","log","preRender","camera","queue","enabled","replaceMaterial","postRender","readColorFromRenderTarget","object","pick","x","y","gl","renderhardware","screenPoint","canvas","clientWidth","clientHeight","canvasWidth","drawingBufferWidth","canvasHeight","drawingBufferHeight","px","py","viewport","viewWidth","z","viewHeight","w","nx","ny","left","Math","floor","width","bottom","height","pixel","Uint8Array","getColorTexture","getPixelBuffer","RenderPass","FramebufferPicker","_camera","value","_renderPipeline","addRenderPass","colorRenderPass","entity","colorRenderTarget","RenderTarget","RenderColorTexture","offsetX","offsetY","onUpdate","deltaTime","onDestroy","removeRenderPass","fun","Script"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;AAIAA,MAAM,CAACC,MAAP,CAAc,0BAAd,EAA0CC,EAA1C,EAA8CC,EAA9C;AAEA;AACA;AACA;;IACaC,aAAb;AAAA;;AAIE,yBAAYC,MAAZ,EAA4B;AAAA;;AAC1B,iCAAMA,MAAN,EAAcL,MAAM,CAACM,IAAP,CAAY,0BAAZ,CAAd;AAD0B,UAHpBC,UAGoB,GAHC,CAGD;AAAA,UAFpBC,cAEoB,GAFH,EAEG;AAAA;AAE3B;AAED;AACF;AACA;;;AAVA;;AAAA,SAWEC,KAXF,GAWE,iBAAc;AACZ,SAAKF,UAAL,GAAkB,CAAlB;AACA,SAAKC,cAAL,GAAsB,EAAtB;AACD;AAED;AACF;AACA;AAlBA;;AAAA,SAmBEE,QAnBF,GAmBE,kBAASC,EAAT,EAA8B;AAC5B,QAAIA,EAAE,IAAI,QAAV,EAAoB;AAClBC,MAAAA,MAAM,CAACC,IAAP,CAAY,8DAA8D,QAA1E;AACA,aAAO,IAAIC,OAAJ,CAAY,CAAZ,EAAe,CAAf,EAAkB,CAAlB,CAAP;AACD;;AAED,QAAMC,KAAK,GAAG,IAAID,OAAJ,CAAY,CAACH,EAAE,GAAG,IAAN,IAAc,GAA1B,EAA+B,CAAC,CAACA,EAAE,GAAG,MAAN,KAAiB,CAAlB,IAAuB,GAAtD,EAA2D,CAAC,CAACA,EAAE,GAAG,QAAN,KAAmB,EAApB,IAA0B,GAArF,CAAd;AACA,WAAOI,KAAP;AACD;AAED;AACF;AACA;AACA;AAhCA;;AAAA,SAiCEC,QAjCF,GAiCE,kBAASD,KAAT,EAAwB;AACtB,WAAOA,KAAK,CAAC,CAAD,CAAL,GAAYA,KAAK,CAAC,CAAD,CAAL,IAAY,CAAxB,GAA8BA,KAAK,CAAC,CAAD,CAAL,IAAY,EAAjD;AACD;AAED;AACF;AACA;AAvCA;;AAAA,SAwCEE,gBAxCF,GAwCE,0BAAiBF,KAAjB,EAAwB;AACtB,WAAO,KAAKP,cAAL,CAAoB,KAAKQ,QAAL,CAAcD,KAAd,CAApB,CAAP;AACD;AAED;AACF;AACA;AA9CA;;AAAA,SA+CEG,UA/CF,GA+CE,oBAAWC,aAAX,EAAyC;AAAA,QAC/BC,SAD+B,GACND,aADM,CAC/BC,SAD+B;AAAA,QACpBC,SADoB,GACNF,aADM,CACpBE,SADoB;AAEvC,SAAKd,UAAL,IAAmB,CAAnB;AACA,SAAKC,cAAL,CAAoB,KAAKD,UAAzB,IAAuC;AAAEa,MAAAA,SAAS,EAATA,SAAF;AAAaC,MAAAA,SAAS,EAATA;AAAb,KAAvC;AACAD,IAAAA,SAAS,CAACE,UAAV,CAAqBC,UAArB,CAAgC,WAAhC,EAA6C,KAAKb,QAAL,CAAc,KAAKH,UAAnB,CAA7C;AACD,GApDH;;AAAA;AAAA,EAAmCiB,QAAnC;;ACNA;AACA;AACA;;IACMC;;;AAKJ,2BAAYC,IAAZ,EAA0BC,QAA1B,EAA4CC,YAA5C,EAAwEC,IAAxE,EAAqFxB,MAArF,EAAsG;AAAA;;AACpG,mCAAMqB,IAAN,EAAYC,QAAZ,EAAsBC,YAAtB,EAAoC,IAAIxB,aAAJ,CAAkBC,MAAlB,CAApC,EAA+DwB,IAA/D;AADoG,UAJ9FC,SAI8F;AAAA,UAH9FC,MAG8F;AAAA,UAF9FC,QAE8F;AAGpG,UAAKF,SAAL,GAAiB,KAAjB;;AACA,UAAKC,MAAL,GAAc,UAACE,CAAD;AAAA,aAAYC,OAAO,CAACC,GAAR,CAAYF,CAAZ,CAAZ;AAAA,KAAd;;AAJoG;AAKrG;AAED;AACF;AACA;AACA;;;;;SACEG,YAAA,mBAAUC,MAAV,EAAkBC,KAAlB,EAAyB;AACvB,QAAI,KAAKR,SAAT,EAAoB;AAClB,WAAKS,OAAL,GAAe,IAAf;AACC,WAAKC,eAAN,CAAwC/B,KAAxC;AACD,KAHD,MAGO;AACL,WAAK8B,OAAL,GAAe,KAAf;AACD;AACF;AAED;AACF;AACA;AACA;;;SACEE,aAAA,oBAAWJ,MAAX,EAA2BC,KAA3B,EAAkC;AAChC,QAAI,KAAKR,SAAT,EAAoB;AAClB,UAAMf,KAAK,GAAG,KAAK2B,yBAAL,CAA+BL,MAA/B,CAAd;AACA,UAAMM,MAAM,GAAI,KAAKH,eAAN,CAAwCvB,gBAAxC,CAAyDF,KAAzD,CAAf;AACA,WAAKe,SAAL,GAAiB,KAAjB;AAEA,UAAI,KAAKC,MAAT,EAAiB,KAAKA,MAAL,CAAYY,MAAZ;AAClB;AACF;AAED;AACF;AACA;;;SACEC,OAAA,cAAKC,CAAL,EAAgBC,CAAhB,EAA2B;AACzB,SAAKd,QAAL,GAAgB,CAACa,CAAD,EAAIC,CAAJ,CAAhB;AACA,SAAKhB,SAAL,GAAiB,IAAjB;AACD;AAED;AACF;AACA;;;SACEY,4BAAA,mCAA0BL,MAA1B,EAA0C;AACxC,QAAMU,EAAE,GAAGV,MAAM,CAAChC,MAAP,CAAc2C,cAAd,CAA6BD,EAAxC;AACA,QAAME,WAAW,GAAG,KAAKjB,QAAzB;AACA,QAAMkB,MAAM,GAAGH,EAAE,CAACG,MAAlB;AACA,QAAMC,WAAW,GAAGD,MAAM,CAACC,WAA3B;AACA,QAAMC,YAAY,GAAGF,MAAM,CAACE,YAA5B;AACA,QAAMC,WAAW,GAAGN,EAAE,CAACO,kBAAvB;AACA,QAAMC,YAAY,GAAGR,EAAE,CAACS,mBAAxB;AAEA,QAAMC,EAAE,GAAIR,WAAW,CAAC,CAAD,CAAX,GAAiBE,WAAlB,GAAiCE,WAA5C;AACA,QAAMK,EAAE,GAAIT,WAAW,CAAC,CAAD,CAAX,GAAiBG,YAAlB,GAAkCG,YAA7C;AAEA,QAAMI,QAAQ,GAAGtB,MAAM,CAACsB,QAAxB;AACA,QAAMC,SAAS,GAAG,CAACD,QAAQ,CAACE,CAAT,GAAaF,QAAQ,CAACd,CAAvB,IAA4BQ,WAA9C;AACA,QAAMS,UAAU,GAAG,CAACH,QAAQ,CAACI,CAAT,GAAaJ,QAAQ,CAACb,CAAvB,IAA4BS,YAA/C;AAEA,QAAMS,EAAE,GAAG,CAACP,EAAE,GAAGE,QAAQ,CAACd,CAAf,IAAoBe,SAA/B;AACA,QAAMK,EAAE,GAAG,CAACP,EAAE,GAAGC,QAAQ,CAACb,CAAf,IAAoBgB,UAA/B;AACA,QAAMI,IAAI,GAAGC,IAAI,CAACC,KAAL,CAAWJ,EAAE,IAAI,KAAKpC,YAAL,CAAkByC,KAAlB,GAA0B,CAA9B,CAAb,CAAb;AACA,QAAMC,MAAM,GAAGH,IAAI,CAACC,KAAL,CAAW,CAAC,IAAIH,EAAL,KAAY,KAAKrC,YAAL,CAAkB2C,MAAlB,GAA2B,CAAvC,CAAX,CAAf;AACA,QAAMC,KAAK,GAAG,IAAIC,UAAJ,CAAe,CAAf,CAAd;AAEA,SAAK7C,YAAL,CAAkB8C,eAAlB,GAAoCC,cAApC,CAAmD,IAAnD,EAAyDT,IAAzD,EAA+DI,MAA/D,EAAuE,CAAvE,EAA0E,CAA1E,EAA6EE,KAA7E;AACA,WAAOA,KAAP;AACD;;;EA1E2BI;;ACH9B;AACA;AACA;AACA;;IACaC,iBAAb;AAAA;;AAAA;AAAA;;AAQE;AACF;AACA;AAVA,wBAWuB;AACnB,aAAO,KAAKC,OAAZ;AACD,KAbH;AAAA,sBAeaC,KAfb,EAe4B;AACxB,UAAI,KAAKD,OAAL,KAAiBC,KAArB,EAA4B;AAC1B,aAAKD,OAAL,GAAeC,KAAf,CAD0B;;AAG1B,aAAK1C,MAAL,CAAY2C,eAAZ,CAA4BC,aAA5B,CAA0C,KAAKC,eAA/C;AACD;AACF;AArBH;;AAuBE,6BAAYC,MAAZ,EAA4B;AAAA;;AAC1B,+BAAMA,MAAN;AAD0B,UAtBrBC,iBAsBqB;AAAA,UArBrBF,eAqBqB;AAAA,UAnBpBJ,OAmBoB;AAAA,UAlBpBhD,SAkBoB;AAAA,UAjBpBE,QAiBoB;AAE1B,QAAMqC,KAAK,GAAG,IAAd;AACA,QAAME,MAAM,GAAG,IAAf;AACA,UAAKa,iBAAL,GAAyB,IAAIC,YAAJ,CACvB,MAAKhF,MADkB,EAEvBgE,KAFuB,EAGvBE,MAHuB,EAIvB,IAAIe,kBAAJ,CAAuB,MAAKjF,MAA5B,EAAoCgE,KAApC,EAA2CE,MAA3C,CAJuB,CAAzB;AAMA,UAAKW,eAAL,GAAuB,IAAIzD,eAAJ,CAAoB,uBAApB,EAA6C,CAAC,CAA9C,EAAiD,MAAK2D,iBAAtD,EAAyE,CAAzE,EAA4E,MAAK/E,MAAjF,CAAvB;AAV0B;AAW3B;AAED;AACF;AACA;AACA;;;AAvCA;;AA8CE;AACF;AACA;AACA;AACA;AAlDA,SAmDEuC,IAnDF,GAmDE,cAAK2C,OAAL,EAAsBC,OAAtB,EAAuC;AACrC,QAAI,KAAKjD,OAAT,EAAkB;AAChB,WAAKT,SAAL,GAAiB,IAAjB;AACA,WAAKE,QAAL,GAAgB,CAACuD,OAAD,EAAUC,OAAV,CAAhB;AACD;AACF,GAxDH;;AAAA,SA0DEC,QA1DF,GA0DE,kBAASC,SAAT,EAA4B;AAC1B,sBAAMD,QAAN,YAAeC,SAAf;;AAEA,QAAI,KAAKnD,OAAL,IAAgB,KAAKT,SAAzB,EAAoC;AAClC,WAAKoD,eAAL,CAAqBtC,IAArB,CAA0B,KAAKZ,QAAL,CAAc,CAAd,CAA1B,EAA4C,KAAKA,QAAL,CAAc,CAAd,CAA5C;AACA,WAAKF,SAAL,GAAiB,KAAjB;AACD;AACF,GAjEH;;AAAA,SAmEE6D,SAnEF,GAmEE,qBAAY;AACV;AACA,SAAKtD,MAAL,CAAY2C,eAAZ,CAA4BY,gBAA5B,CAA6C,KAAKV,eAAlD;AACD,GAtEH;;AAAA;AAAA;AAAA,sBAwCaW,GAxCb,EAwC4B;AACxB,UAAI,OAAOA,GAAP,KAAe,UAAnB,EAA+B;AAC5B,aAAKX,eAAN,CAA8BnD,MAA9B,GAAuC8D,GAAvC;AACD;AACF;AA5CH;;AAAA;AAAA,EAAuCC,MAAvC;;;;"}